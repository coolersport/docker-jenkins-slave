#!/bin/bash

[[ -n "$ZONE" ]] && ZONE="--zone $ZONE"
[[ -n "$REGION" ]] && REGION="--region $REGION"

gcsSetStatus starting

gsutil rm gs://${BUCKET_NAME?required}/scaledown 2>/dev/null

for pool in ${POOL_NAMES?required}; do
    gcloud container clusters resize ${CLUSTER_NAME?required} \
      --node-pool $pool \
      --num-nodes ${1:-1} \
      --project ${PROJECT_ID?required} \
      $ZONE $REGION \
      --quiet
done

for name in ${DB_NAMES}; do
    sqlSetState $name NEVER ALWAYS
done

date +%s > /tmp/last.scaleup
gsutil cp /tmp/last.scaleup gs://$BUCKET_NAME/

gcsSetStatus running
