#!/bin/bash

hook_url() {
    if [[ $1 -le 0 ]]; then
        echo $CHAT_WEBHOOK_URL
    else
        var="CHAT_WEBHOOK_URL_$1"
        echo ${!var}
    fi
}

# at least one valid variable defined
urls=
for i in {0..9}; do
    url=`hook_url $i`
    [[ -z "$url" ]] && continue
    [[ "$url" != 'https://'* ]] && echo Invalid CHAT_WEBHOOK_URL set && exit 1
    urls="${urls}${url}"
done

[[ -z "$urls" ]] && echo CHAT_WEBHOOK_URL undefined && exit 1
[[ -z "$1" ]] && echo 'Syntax: sendChatCard "message" [buttonLabel buttonLink]...' && exit 1

# https://developers.google.com/hangouts/chat/reference/message-formats/cards

button() {
[[ -z $1 || -z $2 ]] && return
cat <<BUTTON
${3}{
    "textButton": {
        "text": "$1",
        "onClick": {
            "openLink": {
                "url": "$2"
            }
        }
    }
}
BUTTON
}

if [[ -z "$MESSAGE_CARD_HEADER" ]]; then
	MESSAGE_CARD_HEADER=${JOB_BASE_NAME:-Header}
fi
if [[ -z "$MESSAGE_CARD_SUBTITLE" ]]; then
	MESSAGE_CARD_SUBTITLE="Build #${BUILD_NUMBER}"
fi
THREADKEY=$(echo -n ${BUILD_TAG:-`date +'%Y%m%d%H'`} | sha256sum | cut -d' ' -f1)
RUN_DISPLAY_URL=${RUN_DISPLAY_URL:-https://jenkins.service.genixventures.com}
MSG=$1
shift

header_text() {
    if [[ $1 -le 0 ]]; then
        echo $MESSAGE_CARD_HEADER
    else
        var="MESSAGE_CARD_HEADER_$1"
        if [[ -n ${!var} ]]; then
            echo ${!var}
        else
            echo $MESSAGE_CARD_HEADER
        fi
    fi
}
subtitle_text() {
    if [[ $1 -le 0 ]]; then
        echo $MESSAGE_CARD_SUBTITLE
    else
        var="MESSAGE_CARD_SUBTITLE_$1"
        if [[ -n ${!var} ]]; then
            echo ${!var}
        else
            echo $MESSAGE_CARD_SUBTITLE
        fi
    fi
}

buttons=`button "View Details" "${RUN_DISPLAY_URL:-https://jenkins.service.genixventures.com}"`
while [[ -n "$1" || -n "$2" ]]; do
	buttons=$buttons`button "$1" "$2" ,`
	shift
	shift
done

for i in {0..9}; do
# for loop begins
url=`hook_url $i`
[[ -z "$url" ]] && continue
header=`header_text $i`
subtitle=`subtitle_text $i`

if [[ -n "$DEBUG_MODE" ]]; then
    echo $header
    echo $subtitle
    echo $url
    continue
fi

output=`mktemp`
code=$(curl -s -o $output -w "%{http_code}" -X POST -H 'Content-Type: application/json' "$url&threadKey=$THREADKEY" -d @- <<EOF
{
    "cards": [
        {
            "header": {
                "title": "${header//\"/\\\"}",
                "subtitle": "${subtitle//\"/\\\"}",
                "imageUrl": "https://lh3.googleusercontent.com/proxy/fI_xSzgrxu6Ckw7OSHbutybNupGcnX2tyqnoVG3qZSmDDQcPDJ2YvVwuj5ZM3wi7hzb-CArqASXsre6Mdiv9GsndmYi7CuWeAQdko5VhjreSlxBVqW5qur6F9Q=s88-c-k-no-mo"
            },
            "sections": [
                {
                    "widgets": [
                        {
                            "textParagraph": {
                                "text": "${MSG//\"/\\\"}"
                            }
                        },
                        {
                            "buttons": [${buttons}]
                        }
                    ]
                }
            ]
        }
    ]
}
EOF
)

if [[ $code -ge 400 ]]; then
	cat $output
	exit 1
else
	rm -rf $output
fi

# for loop ends
done